# 1.大型网站架构演化

## 1.1大型网站软件系统的特点

- 高并发，大流量
- 高可用：系统7*24小时不间断服务。
- 海量数据
- 用户分布广泛，网络情况复杂
- 安全环境恶劣
- 需求快速变更，发布频繁
- 渐进式发展

## 1.2大型网站架构演化发展历程

大型网站的技术挑战主要来自庞大的用户，高并发的访问和海量的数据，任何简单的业务一旦需要处理数以P计的数据和面对数以亿计的用户，问题就会变得很棘手。大型网站架构主要就是解决这类问题。

### 1.2.1初始阶段的网站架构

应用程序，数据库，文件等所有的资源文件都在一台服务器上。通常服务器操作系统使用Linux，应用程序使用PHP开发，然后部署在apache上，数据库使用MySQL，汇集各种免费开源软件及一台廉价服务器就可以开始网站的发展之路。

### 1.2.2应用服务和数据服务分离

越来越多的用户访问导致性能越来越差，越来越多的数据导致存储空间不足。这时就需要将应用和数据分离。应用和数据分离后整个网站使用三台服务器：应用服务器、文件服务器和数据库服务器。三台服务器的硬件资源也不相同：应用服务器需要处理大量的业务逻辑，因此需要更快更强大的CPU；数据库服务器需要快速磁盘检索和数据缓存，因此需要更快的硬盘和更大的内存；文件服务器需要存储大量用户上传的文件，因此需要更大的硬盘。

### 1.2.3使用缓存改善网站性能

网站访问的特点：80%的业务访问集中在20%的数据上。可以使用缓存大幅改善网站性能。

网站使用的缓存可以分为两种：缓存在应用服务器上的本地缓存和缓存在专门的分布式缓存服务器上的远程缓存。本地缓存的访问速度更快一些，但是受应用服务器内存限制，其缓存数量有限，而且会出现和应用程序争用内存的情况。远程分布式缓存可以使用集群方式，部署大内存的服务器作为专门的缓存服务器，可以在理论上做到不受内存容量限制的缓存服务。

### 1.2.4使用应用服务器集群改善网站的并发处理能力

使用集群解决网站高并发、海量数据问题。使用负载均衡调度器，可将来自用户浏览的访问请求分发到应用服务器集群中的任何一台服务器上，如果有更多的用户，就在集群中加入更多的应用服务器，使应用服务器的负载压力不再成为整个网站的瓶颈。

### 1.2.5数据库读写分离

应用服务器在写数据的时候，访问主数据库，主数据库通过主从复制机制将数据更新同步到从数据库，这样当应用服务器读数据的时候，就可通过从数据库获得数据。为了便于应用程序访问读写分离后的数据库，通常在应用服务器端使用专门的数据访问模块，使数据库读写分离对应透明。

### 1.2.6使用反向代理和CDN加速网站响应

由于中国复杂的网络环境，不同地区的用户访问网站时，速度差别也极大。可以使用反向代理和CDN实现网络加速。

CDN和反向代理的基本原理都是缓存，区别在于CDN部署在网络提供商的机房，使用户在请求网站服务时，可以从距离自己最近的网络提供上机房获取数据；而反向代理则部署在网站的中心机房，当用户请求到达中心机房后，首先访问的服务器时反向代理服务器，如果反向代理服务器中缓存着用户请求资源，就将其直接返回给用户。

使用CDN和反向代理的目的都是尽早返回数据给用户，一方面加快用户访问速度，另一方面也减轻后端服务器的负载压力。

### 1.2.7使用分布式文件系统和分布式数据库系统

分布式数据库是网站数据库拆分的最后手段，只有在单表数据规模非常庞大的时候才使用。不到万不得已时，网站更常用的数据库拆分手段时业务分库，将不同业务的数据库部署在不同的物理服务器上。

### 1.2.8使用NoSQL和搜索引擎

NoSQL和搜索引擎都是源自互联网的技术手段，对可伸缩的分布式特性具有更好的支持。应用服务器则通过一个统一数据访问模块访问各种数据，减轻应用程序管理诸多数据源的麻烦。

### 1.2.9业务拆分

大型网站为了应对日益复杂的业务场景，通过使用分而治之的手段将整个网站业务分成不同的产品线，如大型购物交易网站就会将首页、商铺、订单和卖家等拆分成不同的产品线，分归不同团队负责。

集体到技术上，也会根据产品线划分，将一个网站拆分成许多不同的应用，每个应用独立部署。应用之间可以通过一个超链接建立关系，也可以通过消息队列进行数据分发，当然最多的还是通过访问同一个数据存储系统来构成一个关联的完整系统。

### 1.2.10分布式服务

随着业务拆分越来越小，存储系统越做越大，应用系统的整体复杂程度呈指数级增加，部署维护越来越困难。由于所有用要和所有数据库系统链接，在数万台服务器规模的网站中，这些链接的数目时服务器规模的平方，导致数据库连接资源不足，拒绝服务。

既然每一个应用系统都需要执行许多相同的业务操作，比如用户管理、商品管理等，那么可以将这些共用的业务提取出来，独立部署。由这些可复用的业务链接数据库，提供共用业务服务，而应用系统只需要管理用户界面。

# 2.大型网站结构模式

## 2.1网站架构模式

### 2.1.1分层

将系统在横向维度上切分成几个部分，每个部分负责一部分相对比较单一的职责，然后通过上层对下层的依赖和调用组成一个完整的系统。

1. 应用层：负责具体业务和视图展示，如网站首页及搜索输入和结果展示
2. 服务层：为应用层提供支持，如用户管理和购物车服务等
3. 数据层：提供数据存储访问服务，如数据库，缓存，文件，搜索引擎

### 2.1.2分割

网站越大，功能越复杂，服务和数据处理的种类也越多，将这些不同功能和服务分割开来，包装成高内聚低耦合的模块单元，乙方main有助于软件的开发和维护，另一方面便于不同模块的分布式部署，提高网站的并发处理能力和功能扩展能力。

### 2.1.3分布式

分布式意味着可以使用更多的计算机完成同样的功能。

1. 分布式应用和服务：将分层和分割后的应用和服务模块分布式部署， 除了可以改善网站性能和并发性、 加快开发和发布速度、 减少数据库连接资源消耗外；还可以使不同 应用复用共同的服务， 便于业务功能扩展
2. 分布式静态资源：网站的静态资源如 JS, CSS, Logo 图片等资源独立分布式部署，并采用独立的域名， 即人们常说的动静分离。静态资源分布式部署可以减轻应用服务器的负载压力；通过使用独立域名加快浏览器并发加载的速度；由负责用户体验的团队进行开发维护有利于网站分工合作， 使不同技术工种术业有专攻
3. 分布式数据和存储：大型网站需要处理以P为单位的海量数据， 单台计算机无法提供如此大的存储空间， 这些数据需要分布式存储。除了对传统的关系数据库进行分布式 部署外， 为网站应用而生的各种 NoSQL 产品几乎都是分布式的
4. 分布式计算：严格说来， 应用、 服务 实时数据处理者R是计算， 网站除了要处理这些在线业务， 还有很大 部分用户没有直观感受的后台业务要处理， 包括搜索引擎的索引构建、数据仓库的数据分析统计等。

此外， 还有可以支持网站线上服务器配置实时更新的分布式配置；分布式环境下实现并发和协同的分布式锁；支持云存储的分布式文件系统等。

### 2.1.4集群

但是对于用户访问集中的模块（比如网站的首页）， 还需要将独立部署的服务器集群化，即多台服务器部署相同应用构成一个集群，通过负载均衡设备共同对外提供服务。可以很好的提高并发性。

### 2.1.5缓存

缓存就是将数据存放在距离计算最近的位置以加快处理速度。 缓存是改善软件性能 的第一手段。

CDN：即内容分发网络，部署在距离终端用户最近的网络服务商， 用户的网络请求总是先到达他的网络服务商那里，在这里缓存网站的一些静态资源（较少变化的数据）， 可以就近以最快速度返回给用户， 如视频网站和门户网站会将用户访问量大的热点内容 缓存在CDN。

反向代理：反向代理属于网站前端架构的一部分，部署在网站的前端， 当用户请求 到达网站的数据中心时， 最先访问到的就是反向代理服务器，这里缓存网站的静态资源， 无需将请求继续转发给应用服务器就能返回给用户。

本地缓存：在应用服务器本地缓存着热点数据，应用程序可以在本机内存中直接访 问数据， 而无需访问数据库。

分布式缓存：大型网站的数据量非常庞大， 即使只缓存一小部分，需要的内存空间也不是单机能承受的，所以除了本地缓存，还需要分布式缓存，将数据缓存在一个专门 的分布式缓存集群中，应用程序通过网络通信访问缓存数据。

### 2.1.6异步

大型网站架构中， 系统解藕合的手段除了前 面提到的分层、 分割 飞 分布等， 还有一个重要手段是异步，业务之间的消息传递不是同 步调用， 而是将一个业务操作分成多个阶段， 每个阶段之间通过共享数据的方式异步执行进行协作。