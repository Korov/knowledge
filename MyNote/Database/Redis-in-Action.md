# Redis in Action

# 1 初识Redis

Redis提供了5种不同类型的数据结构，各式各样的问题都可以很自然地映射到这些数据结构上，除此之外，通过复制、持久化和客户端分片等特性，用户可以很方便地将Redis扩展成一个能够包含数百GB数据、每秒处理上百万次请求的系统。

## 1.1 Redis简介

Redis是一个速度非常快的非关系数据库，它可以存储键与5种不同类型的值之间的映射，它可以将存储在内存的键值对数据持久化到硬盘，可以使用复制特性来扩展读性能，还可以使用客户端分片来扩展写性能。

### 1.1.1 Redis与其他数据库软件的对比

**Redis不是用表**。高性能键值缓存服务器memcached与Redis对比：两者都可以用于存储键值映射，彼此的性能也相差无几，但Redis能够自动以两种不同的方式将数据写入硬盘，并且Redis除了能存储普通的字符串键之外，还可以存储其他4种数据结构，而memcached只能存储普通的字符串键。

### 1.1.2 附加特性

Redis有两种不同形式的持久化方法，他们都可以用小而紧凑的格式将存储在内存中的数据写入硬盘：

1. 时间点转储，转储操作既可以在“指定时间段内有指定数量的写操作执行”这一条被满足时执行，又可以通过调用两条转储到硬盘命令中的任何一条来执行
2. 将所有修改了数据库的命令都写入一个追加文件里面，用户可以根据数据的重要程度，将只追加写入设置为不同步，每秒同步一次或者每写入一个命令就同步一次。

## 1.2 Redis数据结构简介

Redis可以存储键与5种不同数据结构类型之间的映射，这5种数据结构类型分别为STRING（字符串）、LIST（列表）、SET（集合）、HASH（散列）、和ZSET（有序集合）。

| 结构类型 | 结构存储的值                                                 | 结构的读写能力                                               |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| STRING   | 可以是字符串、证书或者浮点数                                 | 对整个字符串或者字符串的其中一部分执行操作；对整数和浮点数执行自增或者自减操作 |
| LIST     | 一个链表，链表上的每个节点都包含了一个字符串                 | 从链表的两端推入或者弹出元素；根据偏移量对链表进行修剪；读取单个或者多个元素；根据值查找或者移除元素 |
| SET      | 包含字符串的无序收集器，并且被包含的每个字符串都是独一无二的、各不相同 | 添加、获取、移除单个元素；检查一个元素是否存在于集合中；计算交集、并集、差集；从几何里面随机获取元素 |
| HASH     | 包含键值对的无序散列表                                       | 添加、获取、移除单个键值对；获取所有键值对                   |
| ZSET     | 字符串成员与浮点数分值之间的有序映射，元素的排列顺序由分值的大小决定 | 添加、获取、移除单个元素；根据分值范围或者成员来获取元素     |

### 1.2.1 Redis中的字符串

![image-20191126205034438](picture\image-20191126205034438.png)

| 命令 | 行为                                               | 示例                                      |
| ---- | -------------------------------------------------- | ----------------------------------------- |
| GET  | 获取存储在给定键值中的值                           | get hello                                 |
| SET  | 设置存储在给定键中的值                             | set hello world(key为hello，value为world) |
| DEL  | 删除存储在给定键中的值（这个命令可以用于所有类型） | del hello                                 |

### 1.2.2 Redis中的列表

![image-20191126205430753](picture\image-20191126205430753.png)

| 命令   | 行为                           | 示例                                                         |
| ------ | ------------------------------ | ------------------------------------------------------------ |
| LPUSH  | 将给定值推入列表的左端         |                                                              |
| RPUSH  | 将给定值推入列表的右端         | rpush list-key item(可以跟随多个值)                          |
| LRANGE | 获取列表在给定范围上的所有值   | lrange key start stop(start表示起始位置从0开始，stop表示结束位置-1表示最后) |
| LINDEX | 获取列表在给定位置上的单个元素 | lindex key index                                             |
| LPOP   | 从列表的左端弹出一个值         |                                                              |
| RPOP   | 从列表的右端弹出一个值         |                                                              |
|        |                                |                                                              |

### 1.2.3 Redis的集合

![image-20191126210647676](picture\image-20191126210647676.png)

| 命令      | 行为                                         | 示例                          |
| --------- | -------------------------------------------- | ----------------------------- |
| SADD      | 将给定元素添加到集合                         | sadd key member [members ...] |
| SMEMBERS  | 返回集合包含的所有元素                       | smembers key                  |
| SISMEMBER | 检查给定元素是否存在于集合中                 | sismember key member          |
| SREM      | 如果给定的元素存在于集合中，那么移除这个元素 | srem key member [members ...] |

### 1.2.4 Redis的散列

![image-20191126211239902](picture\image-20191126211239902.png)

| 命令    | 行为                                     | 示例                       |
| ------- | ---------------------------------------- | -------------------------- |
| HSET    | 在散列里面关联起给定的键值对             | hset key field value       |
| HGET    | 获取指定散列的值                         | hget key field             |
| HGETALL | 获取散列包含的所有键值对                 | hgetall key                |
| HDEL    | 如果给定键存在于散列里面，那么移除这个键 | hdel key field [field ...] |

### 1.2.5 Redis的有序集合

![image-20191126211806660](picture\image-20191126211806660.png)

这是一个**集合**，里面存储一个member（成员）和一个score（分值），分值必须为浮点数，可以根据成员访问元素，又可以根据分值以及分值的排列顺序来访问元素。有序集合使用分值来排序。

| 命令          | 行为                                                       | 实例                                                         |
| ------------- | ---------------------------------------------------------- | ------------------------------------------------------------ |
| ZADD          | 将一个带有给定分值的成员添加到有序集合里面                 | zadd key score member                                        |
| ZRANGE        | 根据元素在有序排列中所处的位置，从有序集合里面获取多个元素 | zrange key start stop [withscores]                           |
| ZRANGEBYSCORE | 获取有序集合在给定分值范围内的所有元素                     | ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]，`min` 和 `max` 可以是 `-inf` 和 `+inf`代表无限大和无限小。默认为大于等于min小于等于max。limit代表分页查询，offset起始位置，count获取的数量 |
| ZREM          | 如果给定成员存在于有序集合，那么移除这个成员               | zrem key member [member ...]                                 |

# 3 Redis命令

## 3.1 字符串

字符串是一个由字节组成的序列，可以存储以下3种类型的值：

1. 字节串（byte string）
2. 整数
3. 浮点数

可以通过给定的任意数值对存储着整数或者浮点数的字符串执行自增或者自减操作，在有需要的时候，Redis还会将整数转换成浮点数。整数的取值范围和系统的长整数的取值范围相同（32位系统上，整数就是32位有符号整数），而浮点数的取值范围和精度则与IEEE754标准的双精度浮点数（double）相同。

**Redis中的自增命令和自减命令**

| 命令        | 描述                         | 示例                      |
| ----------- | ---------------------------- | ------------------------- |
| INCR        | 将键存储的值加1              | incr key                  |
| DECR        | 将键存储的值减1              | decr key                  |
| INCRBY      | 将键存储的值加上指定整数     | incrby key increment      |
| DECRBY      | 将键存储的值减去指定整数     | decrby key decrement      |
| INCRBYFLOAT | 将键存储的值加上指定的浮点数 | incrbyfloat key increment |

**Redis处理子串和二进制位的命令**

| 命令     | 描述                                                         | 示例                                  |
| -------- | ------------------------------------------------------------ | ------------------------------------- |
| APPEND   | 将value追加到给定键当前存储的值得末尾                        | append key value                      |
| GETRANGE | 获取一个由偏移量start至偏移量end范围内所有字符串组成的子串，包括start和end在内 | getrange key start end                |
| SETRANGE | 将从start偏移量开始的子串设置为给定值                        | setrange key offset value             |
| GETBIT   | 将字节串看作是二进制位串，并返回位串中偏移量为offset的二进制位的值 | getbit key offset                     |
| SETBIT   | 将字节串看做是二进制位串，并将位串中偏移量为offset的二进制位的值设置为value | setbit key offset value               |
| BITCOUNT | 统计二进制位串里面值为1的二进制位的数量，如果给定了可选的start偏移量和end偏移量，那么只对偏移量指定范围内的二进制位进行统计局 | bitcount key [start end]              |
| BITOP    | 对一个或多个二进制位串执行包括并（and）、或（or）、异或（xor）、非（not）在内的任意一种按位运算操作，并将计算得出的结果保存在间destkey键里面 | bitop operation destkey key [key ...] |

在使用setrange或者setbit命令对字符串进行写入的时候，如果字符串当前长度不能满足写入的要求，那么Redis会自动地使用空字节（null）来将字符串扩展至所需的长度，然后才执行写入或者更新操作。在使用getrange读取字符串的时候，超出字符串末尾的数据会被视为空串，而在使用getbit读取二进制位串的时候，超出字符串末尾的二进制位会被视为是0。

## 3.2 列表

以下几个命令可以将元素从一个列表移动到另一个列表，或者阻塞执行命令的客户端直到有其他客户端给列表添加元素为止

