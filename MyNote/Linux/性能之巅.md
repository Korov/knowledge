# 观测工具

## 监视（sar）

```bash
# sysstat包含以下sar,iostat,sa1,sa2,sadf,mpstat,sadc,sysstat
dnf install sysstat
```

sar是基于计数器的，在预定的时间（通过cron）执行以记录系统计数器的状态。

默认状态下，sar读取自己统计信息的归档数据（若开启）来打印历史统计信息。你可以指定时间间隔和次数，按照所指定的频率检查当前的活动。

# 动态追踪技术漫谈

## 什么是动态追踪技术

动态追踪技术通常是基于操作系统内核来实现的。操作系统内核其实可以控制整个软件世界，因为它其实是处于“造物主”这样的一个地位。它拥有绝对的权限，同时它可以确保我们针对软件系统发出的各种“查询”不会影响到软件系统本身的正常运行。换句话说，我们的这种查询必须是足够安全的，是可以在生产系统上大量使用的。把软件系统作为“数据库”进行查询就会涉及到一个查询方式的问题，显然我们并不是通过 SQL 这样的方式去查询这种特殊的“数据库”。

在动态追踪里面一般是通过探针这样的机制来发起查询。我们会在软件系统的某一个层次，或者某几个层次上面，安置一些探针，然后我们会自己定义这些探针所关联的处理程序。这有点像中医里面的针灸，就是说如果我们把软件系统看成是一个人，我们可以往他的一些穴位上扎一些“针”，那么这些针头上面通常会有我们自己定义的一些“传感器”，我们可以自由地采集所需要的那些穴位上的关键信息，然后把这些信息汇总起来，产生可靠的病因诊断和可行的治疗方案。这里的追踪通常涉及两个维度。一个是时间维度，因为这个软件还一直在运行，它便有一个在时间线上的连续的变化过程。另一个维度则是空间维度，因为可能它涉及到多个不同的进程，包含内核进程，而每个进程经常会有自己的内存空间、进程空间，那么在不同的层次之间，以及在同一层次的内存空间里面，我可以同时沿纵向和横向，获取很多在空间上的宝贵信息。这有点儿像蛛蛛在蛛网上搜索猎物。

## `DTrace`与[`SystemTap`](https://sourceware.org/systemtap/examples/)

`DTrace`移植到Linux的时候并不完整，`SystemTap`是目前 Linux 世界功能最强大，同时也是最实用的动态追踪框架。

SystemTap 的优点是它有非常成熟的用户态调试符号的自动加载，同时也有循环这样的语言结构可以去编写比较复杂的探针处理程序，可以支持很多很复杂的分析处理。当然，SystemTap 也是有缺点的。首先，它并不是 Linux  内核的一部分，就是说它并没有与内核紧密集成，所以它需要一直不停地追赶主线内核的变化。另一个缺点是，它通常是把它的“小语言”脚本（有点像 D  语言哦）动态编译成一个 Linux 内核模块的 C 源码，因此经常需要在线部署 C 编译器工具链和 Linux  内核的头文件。出于这些原因，SystemTap 脚本的启动相比 DTrace 要慢得多，和 JVM 的启动时间倒有几分类似。虽然存在这些缺点，但总的来说，SystemTap 还是一个非常成熟的动态追踪框架。

